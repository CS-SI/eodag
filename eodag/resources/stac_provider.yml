# -*- coding: utf-8 -*-
# Copyright 2018, CS GROUP - France, https://www.csgroup.eu/
#
# This file is part of EODAG project
#     https://www.github.com/CS-SI/EODAG
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
search:
  type: StacSearch
  results_entry: features
  pagination:
    next_page_query_obj: '{{"limit":{items_per_page},"page":{page}}}'
    total_items_nb_key_path: '$.numberMatched'
    next_page_url_key_path: '$.links[?(@.rel="next")].href'
    next_page_query_obj_key_path: '$.links[?(@.rel="next")].body'
    next_page_merge_key_path: '$.links[?(@.rel="next")].merge'
  sort:
    sort_by_tpl: '{{"sortby": [ {{"field": "{sort_param}", "direction": "{sort_order}" }} ] }}'
    sort_order_mapping:
      ascending: asc
      descending: desc
  discover_metadata:
    auto_discovery: true
    metadata_pattern: '^[a-zA-Z0-9_:-]+$'
    search_param: '{{{{"query":{{{{"{metadata}":{{{{"eq":"{{{metadata}}}" }}}} }}}} }}}}'
    search_param_unparsed:
      - filter
      - query
    metadata_path: '$.properties.*'
  discover_product_types:
    fetch_url: '{api_endpoint}/../collections'
    result_type: json
    results_entry: '$.collections[*]'
    generic_product_type_id: '$.id'
    generic_product_type_parsable_properties:
      product:type: '$.id'
    generic_product_type_parsable_metadata:
      description: '$.description'
      instruments: '{$.summaries.instruments#csv_list}'
      constellation: '{$.summaries.constellation#csv_list}'
      platform: '{$.summaries.platform#csv_list}'
      processing:level: '{$.summaries."processing:level"#csv_list}'
      keywords: '{$.keywords#csv_list}'
      license: '$.license'
      title: '$.title'
      missionStartDate: '$.extent.temporal.interval[0][0]'
    metadata_path: '$.properties.*'
  discover_queryables:
    fetch_url: '{api_endpoint}/../queryables'
    product_type_fetch_url: '{api_endpoint}/../collections/{provider_product_type}/queryables'
    result_type: json
    results_entry: '$.properties[*]'
    queryable_parsable_metadata:
      description: '$.description'
      title: '$.title'
      type: '$.type'
      pattern: '$.pattern'
  common_metadata_mapping_path: '$'
  metadata_mapping:
    # OpenSearch Parameters for Collection Search (Table 3)
    product:type:
      - '{{"collections":["{product:type}"]}}'
      - '$.collection'
    sci:doi:
      - '{{"query":{{"sci:doi":{{"eq":"{sci:doi}"}}}}}}'
      - '$.properties."sci:doi"'
    processing:level:
      - '{{"query":{{"processing:level":{{"eq":"{processing:level}"}}}}}}'
      - '$.properties."processing:level"'
    constellation:
      - '{{"query":{{"constellation":{{"eq":"{constellation}"}}}}}}'
      - '$.properties.constellation'
    platform:
      - '{{"query":{{"platform":{{"eq":"{platform}"}}}}}}'
      - '$.properties.platform'
    instruments:
    # to test
      - '{{"query":{{"instruments":{{"eq":"{instrument}"}}}}}}'
      - '{$.properties.instruments#csv_list}'
    # INSPIRE obligated OpenSearch Parameters for Collection Search (Table 4)
    title: '$.id'
    description: '$.properties.description'
    gsd:
      - '{{"query":{{"gsd":{{"eq":"{gsd}"}}}}}}'
      - '$.properties.gsd'
    publicationDate:
      - '{{"query":{{"published":{{"eq":"{publicationDate}"}}}}}}'
      - '$.properties.published'
    # OpenSearch Parameters for Product Search (Table 5)
    sat:absolute_orbit:
      - '{{"query":{{"sat:absolute_orbit":{{"eq":"{sat:absolute_orbit}"}}}}}}'
      - '$.properties."sat:absolute_orbit"'
    sat:relative_orbit:
      - '{{"query":{{"sat:relative_orbit":{{"eq":"{sat:relative_orbit}"}}}}}}'
      - '$.properties."sat:relative_orbit"'
    sat:orbit_state:
      - '{{"query":{{"sat:orbit_state":{{"eq":"{sat:orbit_state}"}}}}}}'
      - '{$.properties."sat:orbit_state"#to_lower}'
    eo:cloud_cover:
      - '{{"query":{{"eo:cloud_cover":{{"lte":"{eo:cloud_cover}"}}}}}}'
      - '$.properties."eo:cloud_cover"'
    sar:instrument_mode:
      - '{{"query":{{"sar:instrument_mode":{{"eq":"{sar:instrument_mode}"}}}}}}'
      - '$.properties."sar:instrument_mode"'
    created:
      - '{{"query":{{"created":{{"eq":"{created}"}}}}}}'
      - '$.properties.created'
    updated:
      - '{{"query":{{"updated":{{"eq":"{updated}"}}}}}}'
      - '$.properties.updated'
    version:
      - '{{"query":{{"version":{{"eq":"{version}"}}}}}}'
      - '$.properties.version'
    # OpenSearch Parameters for Acquistion Parameters Search (Table 6)
    availabilityTime:
      - '{{"query":{{"availabilityTime":{{"eq":"{availabilityTime}"}}}}}}'
      - '$.properties.availabilityTime'
    acquisitionStation:
      - '{{"query":{{"acquisitionStation":{{"eq":"{acquisitionStation}"}}}}}}'
      - '$.properties.acquisitionStation'
    acquisitionSubType:
      - '{{"query":{{"acquisitionSubType":{{"eq":"{acquisitionSubType}"}}}}}}'
      - '$.properties.acquisitionSubType'
    start_datetime: '$.properties.datetime'
    end_datetime:
      - '{{"datetime":"{start_datetime#to_iso_utc_datetime}/{end_datetime#to_iso_utc_datetime}"}}'
      - '$.properties.end_datetime'
    view:sun_azimuth:
      - '{{"query":{{"view:sun_azimuth":{{"eq":"{view:sun_azimuth}"}}}}}}'
      - '$.properties."view:sun_azimuth"'
    view:sun_elevation:
      - '{{"query":{{"view:sun_elevation":{{"eq":"{view:sun_elevation}"}}}}}}'
      - '$.properties."view:sun_elevation"'
    sar:polarizations:
      - '{{"query":{{"sar:polarizations":{{"eq":"{sar:polarizations}"}}}}}}'
      - '{$.properties."sar:polarizations"'
    sar:frequency_band:
      - '{{"query":{{"sar:frequency_band":{{"eq":"{sar:frequency_band}"}}}}}}'
      - '$.properties."sar:frequency_band"'
    # Custom parameters (not defined in the base document referenced above)
    id:
      - '{{"ids":["{id}"]}}'
      - '$.id'
    geometry:
      - '{{"intersects":{geometry#to_geojson}}}'
      - '($.geometry.`str()`.`sub(/^None$/, POLYGON((180 -90, 180 90, -180 90, -180 -90, 180 -90)))`)|($.geometry[*])'
    downloadLink: '$.links[?(@.rel="self")].href'
    quicklook: '$.assets.quicklook.href'
    thumbnail: '$.assets.thumbnail.href'
    # order:status set to ONLINE for consistency between providers
    order:status: '{$.null#replace_str("Not Available","ONLINE")}'
    # Normalization code moves assets from properties to product's attr
    assets: '$.assets'
